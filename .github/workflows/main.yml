name: GitHub â†’ Teams Notifications

# This defines when the workflow runs
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, closed, merged]
  issues:
    types: [opened, closed]

jobs:
  notify:
    runs-on: windows-latest
    environment: notify-teams
    steps:
      - name: Send notification to Teams
        env:
          TEAMS_WEBHOOK: ${{ secrets.TEAMS_WEBHOOK_URL }}
        shell: pwsh
        run: |
          $event = "${env:GITHUB_EVENT_NAME}"
          $repo = "${env:GITHUB_REPOSITORY}"
          $actor = "${env:GITHUB_ACTOR}"

          if ($event -eq "push") {
              $message = "**Push event** by $actor to $repo"
          }
          elseif ($event -eq "pull_request") {
              $json = Get-Content $env:GITHUB_EVENT_PATH | ConvertFrom-Json
              $action = $json.action
              $title = $json.pull_request.title
              $url = $json.pull_request.html_url
              $message = "**Pull Request $action** by $actor`nTitle: $title`nURL: $url"
          }
          elseif ($event -eq "issues") {
              $json = Get-Content $env:GITHUB_EVENT_PATH | ConvertFrom-Json
              $action = $json.action
              $title = $json.issue.title
              $url = $json.issue.html_url
              $message = "**Issue $action** by $actor`nTitle: $title`nURL: $url"
          }
          else {
              $message = "Event: $event by $actor in $repo"
          }

          Invoke-RestMethod -Uri $env:TEAMS_WEBHOOK -Method Post -ContentType "application/json" -Body (@{ text = $message } | ConvertTo-Json)
